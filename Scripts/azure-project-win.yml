parameters:
  name: ''
  path: ''
  graphics: 'NANOVG'
  target: 'All'
  artifactName: ''
  repo: ''

steps:
  - bash: |
      if [ ! -d ./${{ parameters.path }} ]
      then
        mkdir -p ./${{ parameters.path }}
      fi
      cd ./${{ parameters.path }} 
      git clone --recursive ${{ parameters.repo }} ${{ parameters.name }}
    displayName: Clone ${{ parameters.name }} repository

  - bash: |
      graphics=${{ parameters.graphics }}
      if [ $graphics = "LICE" ]
      then
        cd ./${{ parameters.path }}/${{ parameters.name }}/config
        sed -i.bu 's/IGRAPHICS_NANOVG;IGRAPHICS_GL2/IGRAPHICS_LICE/' ${{ parameters.name }}-win.props
      elif [ $graphics = "CAIRO" ]
      then
        cd ./${{ parameters.path }}/${{ parameters.name }}/config
        sed -i.bu 's/IGRAPHICS_NANOVG;IGRAPHICS_GL2/IGRAPHICS_CAIRO/' ${{ parameters.name }}-win.props
      elif [ $graphics = "AGG" ]
      then
        cd ./${{ parameters.path }}/${{ parameters.name }}/config
        sed -i.bu 's/IGRAPHICS_NANOVG;IGRAPHICS_GL2/IGRAPHICS_AGG/' ${{ parameters.name }}-win.props
      fi
    displayName: Set graphics string to ${{ parameters.graphics }}

  - task: VSBuild@1
    inputs:
      solution: '${{ parameters.path }}/${{ parameters.name }}/${{ parameters.name }}.sln'
      vsVersion: '15.0'
      platform: x64
      configuration: '${{ parameters.configuration }}'
    displayName: Compile ${{ parameters.name }} Visual Studio Solution x64

  # - task: VSBuild@1
  #   inputs:
  #     solution: '${{ parameters.path }}/${{ parameters.name }}/${{ parameters.name }}.sln'
  #     vsVersion: '15.0'
  #     platform: Win32
  #     configuration: '${{ parameters.configuration }}'
  #   displayName: Compile ${{ parameters.name }} Visual Studio Solution Win32

  - bash: |
      if [ -d ./${{ parameters.path }}/${{ parameters.name }}/build-win/vst2 ]
      then
        rm -r ./${{ parameters.path }}/${{ parameters.name }}/build-win/vst2
      fi

      if [ -d ./${{ parameters.path }}/${{ parameters.name }}/build-win/vst3 ]
      then
        rm -r ./${{ parameters.path }}/${{ parameters.name }}/build-win/vst3
      fi

      if [ -d ./${{ parameters.path }}/${{ parameters.name }}/build-win/aax ]
      then
        rm -r ./${{ parameters.path }}/${{ parameters.name }}/build-win/aax
      fi

      if [ -d ./${{ parameters.path }}/${{ parameters.name }}/build-win/app ]
      then
        rm -r ./${{ parameters.path }}/${{ parameters.name }}/build-win/app
      fi
    displayName: Delete unwanted files

  # - bash: |
  #     mkdir -p ${{ parameters.path }}/${{ parameters.name }}/build-win/
  #     echo "hello ${{ parameters.graphics }}" > ${{ parameters.path }}/${{ parameters.name }}/build-mac/${{ parameters.graphics }}.txt

  #   displayName: TEST PAYLOAD

  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'WIN_${{ parameters.artifactName }}'
      targetPath: '${{ parameters.path }}/${{ parameters.name }}/build-win'
    displayName: Publish ${{ parameters.name }}